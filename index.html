<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Flight Project</title>
  <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="d3Style.css">
  <script type="text/javascript" src="app.js"></script>
  <script type="text/javascript" src="utils.js"></script>
  <script type="text/javascript" src="trace.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
    crossorigin="anonymous">
    <style>
        .jumbotron {
            text-align: center;
        }
    </style>
   

</head>


<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="">Columbia</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="http://localhost:8000/">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#monthsPlot">Months</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#datesPlot">Date</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#airportsDestinationsPlot">Airports</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#airlinesDelaysPlot">Delays</a>
            </li>
            </ul>
        </div>
    </nav>
    <div id="carouselExampleInterval" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active" data-interval="10000">
            <img src="https://media2.giphy.com/media/l3q2RJWbtSPjyzIZy/giphy.gif" class="d-block w-100" alt="plane_gif">
            </div>
            <div class="carousel-item" data-interval="2000">
            <img src="https://media3.giphy.com/media/xzBfbTHLBrrUI/source.gif" class="d-block w-100" alt="plane_gif">
            </div>
            <div class="carousel-item">
            <img src="https://media.giphy.com/media/ekSh8Qp2noLeM/giphy.gif" class="d-block w-100" alt="plane_gif">
            </div>
        </div>
        <a class="carousel-control-prev" href="#carouselExampleInterval" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleInterval" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>

    
  <div class="container">
    <div class="jumbotron">
        <h1>FLIGHT PROJECT</h1>
    </div>
    <div class="row">
      <div class="col-xs-12  col-md-9">
        <div id="scatter">

        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12  col-md-9">
        
      </div>
    </div>
  </div>

  <p>
        <a href="https://www.kaggle.com/usdot/flight-delays">Kaggle 2015 Flight Delays and Cancellations</a> dataset
        (with <a href="https://www.kaggle.com/smiller933/fixing-airport-codes">this fix</a> for some airport codes).
    It has information about flights for major US airlines in 2015 (arrival/departure times, delay, flight ID, distance, ...)
    and information about airport cities/coordinates, airlines.
    </p>
    <p>
        The data was retrieved via SQL queries in PostgresSQL database, Python andPandas in Jupyter Notebook.
    </p>


    <h1>The most/least busiest months of the year</h1>
    <svg id="monthsPlot" class="plot" width="600" height="300"></svg>

    <div class="code-spoiler">
        <a data-toggle="collapse" role="button">SQL</a>
        <div class="collapse">
            <div class="card card-body code-panel">
                <pre class="code"><code>SELECT month, count(*)
FROM flights
GROUP BY month</code></pre>
            </div>
        </div>
    </div>

    <h3 class="plot-title">Flights by date</h3>
    <div>Hover to see data at the selected point.</div>
    <svg id="datesPlot" class="plot" width="800" height="300"></svg>

    <div class="code-spoiler">
        <a data-toggle="collapse" role="button">SQL</a>
        <div class="collapse">
            <div class="card card-body code-panel">
                <pre class="code"><code>SELECT make_date(year, month, day) as date, count(*)
FROM flights
GROUP BY date</code></pre>
            </div>
        </div>
    </div>

    <p>
        As we can see, the most busiest months are in the summer (especially July-August), probably because of holidays,
        also there are some increases in the beginning of Spring (Easter, Spring break?),
        and the least active period is from middle of January to middle of February.
    </p>
    <p>
        Also it depends on day of the week: there is a huge drop of activity on Saturdays, probably related to business trips.
    </p>

    <h1>Airports with the most flight destinations</h1>
    <svg id="airportsDestinationsPlot" class="plot" width="800" height="300"></svg>

    <div class="code-spoiler">
            <a data-toggle="collapse" role="button">SQL</a>
            <div class="collapse">
                <div class="card card-body code-panel">
                    <pre class="code"><code>select count(f.destination_airport), f.destination_airport
from flights f
group by f.destination_airport
order by count(f.destination_airport) desc</code></pre>
                </div>
            </div>
        </div>

    
    

    <h1>Airlines with the most/least delays</h1>
    <p>Circle size represents airline size (number of flights) and Y axis shows its' delay rate (counting only delays that were longer than 10 minutes).</p>
    <svg id="airlinesDelaysPlot" class="plot" width="800" height="300"></svg>

    <div class="code-spoiler">
        <a data-toggle="collapse" role="button">SQL</a>
        <div class="collapse">
            <div class="card card-body code-panel">
                <pre class="code"><code>SELECT airline,
       ROUND(count(*) / (SELECT count(*) FROM flights WHERE f.airline=f.airline)::decimal, 4) as delay_rate,
       (SELECT count(*) FROM flights WHERE airline=f.airline) as flights_count
FROM flights as f
WHERE departure_delay > 10
GROUP BY airline</code></pre>
            </div>
        </div>
    </div>

    <p>The chart shows that most of the delays occur on flights from big airlines, smaller airlines seem to have less delays.</p>

    <p>
        <h2>Bar chart of Departure Delays vs Days of the Week</h2><img src="https://github.com/walidcol/Flight-Data---Project-2-/blob/master/DEP%20DELAYS%20vs%20DAYS%20OF%20THE%20WEEK.png?raw=true" alt="Bar chart of dep_delays vs days of the week">
    </p>
    <div class="code-spoiler">
        <a data-toggle="collapse" role="button">Pandas</a>
        <div class="collapse">
            <div class="card card-body code-panel">
                <pre class="code"><code>df1 = flights[['DAY_OF_WEEK','DEPARTURE_DELAY']]
    df1.head()</code></pre>
            </div>
        </div>
    </div>
    <p>The bar graph above shows the relationship between the Departure dalays at all airports against the days of the week </p>
    <p>As we can tell from the chart, the most delays happen on Mondays (1.0) and Sundays (7.0). The reason for this is most people return from weekend travels on Sunday and Monday so it makes sense there would be the most delays on those days as most flights will be fully booked and the airport probably at it's busiest. </p>
    
    
    <footer>
        <hr/>
        <a href="https://github.com/walidcol/Flight-Data---Project-2-">Source code</a>
    </footer>
</div>


<script>


        /*weeks = [
            {
                airline: "AA",
                day_of_week: "Monday",
                number_of_flights: 8761
            },
            {
                airline: "AS",
                day_of_week: "Monday",
                number_of_flights: 2599
            },
            {
                airline: "B6",
                day_of_week: "Monday",
                number_of_flights: 4316
            },
            {
                airline: "DL",
                day_of_week: "Monday",
                number_of_flights: 13669
            },
            {
                airline: "EV",
                day_of_week: "Monday",
                number_of_flights: 10431
            },
            {
                airline: "F9",
                day_of_week: "Monday",
                number_of_flights: 1417
            },
            {
                airline: "HA",
                day_of_week: "Monday",
                number_of_flights: 1247
            },
            {
                airline: "MQ",
                day_of_week: "Monday",
                number_of_flights: 6056
            },
            {
                airline: "NK",
                day_of_week: "Monday",
                number_of_flights: 1699
            },
            {
                airline: "OO",
                day_of_week: "Monday",
                number_of_flights: 9845
            },
            {
                airline: "UA",
                day_of_week: "Monday",
                number_of_flights: 8077
            },
            {
                airline: "US",
                day_of_week: "Monday",
                number_of_flights: 6565
            },
            {
                airline: "VX",
                day_of_week: "Monday",
                number_of_flights: 978
            },
            {
                airline: "WN",
                day_of_week: "Monday",
                number_of_flights: 20373
            },
            {
                airline: "AA",
                day_of_week: "Tuesday",
                number_of_flights: 8388
            },
            {
                airline: "AS",
                day_of_week: "Tuesday",
                number_of_flights: 2471
            },
            {
                airline: "B6",
                day_of_week: "Tuesday",
                number_of_flights: 4037
            },
            {
                airline: "DL",
                day_of_week: "Tuesday",
                number_of_flights: 12481
            },
            {
                airline: "EV",
                day_of_week: "Tuesday",
                number_of_flights: 9983
            },
            {
                airline: "F9",
                day_of_week: "Tuesday",
                number_of_flights: 1271
            },
            {
                airline: "HA",
                day_of_week: "Tuesday",
                number_of_flights: 1206
            },
            {
                airline: "MQ",
                day_of_week: "Tuesday",
                number_of_flights: 5826
            },
            {
                airline: "NK",
                day_of_week: "Tuesday",
                number_of_flights: 1661
            },
            {
                airline: "OO",
                day_of_week: "Tuesday",
                number_of_flights: 9109
            },
            {
                airline: "UA",
                day_of_week: "Tuesday",
                number_of_flights: 7556
            },
            {
                airline: "US",
                day_of_week: "Tuesday",
                number_of_flights: 5983
            },
            {
                airline: "VX",
                day_of_week: "Tuesday",
                number_of_flights: 877
            },
            {
                airline: "WN",
                day_of_week: "Tuesday",
                number_of_flights: 20328
            },
            {
                airline: "AA",
                day_of_week: "Wednesday",
                number_of_flights: 8479
            },
            {
                airline: "AS",
                day_of_week: "Wednesday",
                number_of_flights: 2502
            },
            {
                airline: "B6",
                day_of_week: "Wednesday",
                number_of_flights: 4048
            },
            {
                airline: "DL",
                day_of_week: "Wednesday",
                number_of_flights: 12901
            },
            {
                airline: "EV",
                day_of_week: "Wednesday",
                number_of_flights: 10032
            },
            {
                airline: "F9",
                day_of_week: "Wednesday",
                number_of_flights: 1326
            },
            {
                airline: "HA",
                day_of_week: "Wednesday",
                number_of_flights: 1235
            },
            {
                airline: "MQ",
                day_of_week: "Wednesday",
                number_of_flights: 5988
            },
            {
                airline: "NK",
                day_of_week: "Wednesday",
                number_of_flights: 1693
            },
            {
                airline: "OO",
                day_of_week: "Wednesday",
                number_of_flights: 9339
            },
            {
                airline: "UA",
                day_of_week: "Wednesday",
                number_of_flights: 7557
            },
            {
                airline: "US",
                day_of_week: "Wednesday",
                number_of_flights: 6845
            },
            {
                airline: "VX",
                day_of_week: "Wednesday",
                number_of_flights: 906
            },
            {
                airline: "WN",
                day_of_week: "Wednesday",
                number_of_flights: 20330
            },
            {
                airline: "AA",
                day_of_week: "Thursday",
                number_of_flights: 10144
            },
            {
                airline: "AS",
                day_of_week: "Thursday",
                number_of_flights: 3090
            },
            {
                airline: "B6",
                day_of_week: "Thursday",
                number_of_flights: 5058
            },
            {
                airline: "DL",
                day_of_week: "Thursday",
                number_of_flights: 15279
            },
            {
                airline: "EV",
                day_of_week: "Thursday",
                number_of_flights: 11743
            },
            {
                airline: "F9",
                day_of_week: "Thursday",
                number_of_flights: 1596
            },
            {
                airline: "HA",
                day_of_week: "Thursday",
                number_of_flights: 1455
            },
            {
                airline: "MQ",
                day_of_week: "Thursday",
                number_of_flights: 6979
            },
            {
                airline: "NK",
                day_of_week: "Thursday",
                number_of_flights: 1986
            },
            {
                airline: "OO",
                day_of_week: "Thursday",
                number_of_flights: 11256
            },
            {
                airline: "UA",
                day_of_week: "Thursday",
                number_of_flights: 9472
            },
            {
                airline: "US",
                day_of_week: "Thursday",
                number_of_flights: 8055
            },
            {
                airline: "VX",
                day_of_week: "Thursday",
                number_of_flights: 1131
            },
            {
                airline: "WN",
                day_of_week: "Thursday",
                number_of_flights: 23091
            },
            {
                airline: "AA",
                day_of_week: "Friday",
                number_of_flights: 9949
            },
            {
                airline: "AS",
                day_of_week: "Friday",
                number_of_flights: 3045
            },
            {
                airline: "B6",
                day_of_week: "Friday",
                number_of_flights: 4877
            },
            {
                airline: "DL",
                day_of_week: "Friday",
                number_of_flights: 15619
            },
            {
                airline: "EV",
                day_of_week: "Friday",
                number_of_flights: 12017
            },
            {
                airline: "F9",
                day_of_week: "Friday",
                number_of_flights: 1558
            },
            {
                airline: "HA",
                day_of_week: "Friday",
                number_of_flights: 1517
            },
            {
                airline: "MQ",
                day_of_week: "Friday",
                number_of_flights: 6924
            },
            {
                airline: "NK",
                day_of_week: "Friday",
                number_of_flights: 1937
            },
            {
                airline: "OO",
                day_of_week: "Friday",
                number_of_flights: 11258
            },
            {
                airline: "UA",
                day_of_week: "Friday",
                number_of_flights: 9309
            },
            {
                airline: "US",
                day_of_week: "Friday",
                number_of_flights: 7967
            },
            {
                airline: "VX",
                day_of_week: "Friday",
                number_of_flights: 1147
            },
            {
                airline: "WN",
                day_of_week: "Friday",
                number_of_flights: 23092
            },
            {
                airline: "AA",
                day_of_week: "Saturday",
                number_of_flights: 7852
            },
            {
                airline: "AS",
                day_of_week: "Saturday",
                number_of_flights: 2490
            },
            {
                airline: "B6",
                day_of_week: "Saturday",
                number_of_flights: 3850
            },
            {
                airline: "DL",
                day_of_week: "Saturday",
                number_of_flights: 9792
            },
            {
                airline: "EV",
                day_of_week: "Saturday",
                number_of_flights: 7166
            },
            {
                airline: "F9",
                day_of_week: "Saturday",
                number_of_flights: 1005
            },
            {
                airline: "HA",
                day_of_week: "Saturday",
                number_of_flights: 1203
            },
            {
                airline: "MQ",
                day_of_week: "Saturday",
                number_of_flights: 4770
            },
            {
                airline: "NK",
                day_of_week: "Saturday",
                number_of_flights: 1696
            },
            {
                airline: "OO",
                day_of_week: "Saturday",
                number_of_flights: 7973
            },
            {
                airline: "UA",
                day_of_week: "Saturday",
                number_of_flights: 5706
            },
            {
                airline: "US",
                day_of_week: "Saturday",
                number_of_flights: 5583
            },
            {
                airline: "VX",
                day_of_week: "Saturday",
                number_of_flights: 705
            },
            {
                airline: "WN",
                day_of_week: "Saturday",
                number_of_flights: 16633
            },
            {
                airline: "AA",
                day_of_week: "Sunday",
                number_of_flights: 8592
            },
            {
                airline: "AS",
                day_of_week: "Sunday",
                number_of_flights: 2613
            },
            {
                airline: "B6",
                day_of_week: "Sunday",
                number_of_flights: 4247
            },
            {
                airline: "DL",
                day_of_week: "Sunday",
                number_of_flights: 12122
            },
            {
                airline: "EV",
                day_of_week: "Sunday",
                number_of_flights: 9073
            },
            {
                airline: "F9",
                day_of_week: "Sunday",
                number_of_flights: 1357
            },
            {
                airline: "HA",
                day_of_week: "Sunday",
                number_of_flights: 1228
            },
            {
                airline: "MQ",
                day_of_week: "Sunday",
                number_of_flights: 5855
            },
            {
                airline: "NK",
                day_of_week: "Sunday",
                number_of_flights: 1700
            }
        ];


        const svg = d3.select('#airlineWeeksPlot');
        
        const margin = 80;
        const width = 700 - 2 * margin;
        const height = 500 - 2 * margin;

        const chart = svg.append('g')
            .attr('transform', `translate(${margin}, ${margin})`);

        const xScale = d3.scaleBand()
            .range([0, width])
            .domain(weeks.map((s) => s.day_of_week))
            .padding(0.3)
        
        const yScale = d3.scaleLinear()
            .range([height, 0])
            .domain([0, 30000]);

        const makeYLines = () => d3.axisLeft()
            .scale(yScale)

        chart.append('g')
            .attr('transform', `translate(0, ${height})`)
            .call(d3.axisBottom(xScale));

        chart.append('g')
            .call(d3.axisLeft(yScale));
        
        chart.append('g')
            .attr('class', 'grid')
            .call(makeYLines()
                .tickSize(-width, 0, 0)
                .tickFormat('')
            ) 
        
        const barGroups = chart.selectAll()
            .data(weeks)
            .enter()
            .append('g')
        
        barGroups
            .append('rect')
            .attr('class', 'barr')
            .attr('x', (g) => xScale(g.day_of_week))
            .attr('y', (g) => yScale(g.number_of_flights))
            .attr('height', (g) => height - yScale(g.number_of_flights))
            .attr('width', xScale.bandwidth())
            .on('mouseenter', function (actual, i) {
                d3.selectAll('.number_of_flights')
                    .attr('opacity', 0)

                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 0.6)
                    .attr('x', (a) => xScale(a.day_of_week) - 5)
                    .attr('width', xScale.bandwidth() + 10)

                const y = yScale(actual.number_of_flights)



            })
            .on('mouseleave', function () {
                d3.selectAll('.number_of_flights')
                    .attr('opacity', 1)

                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 1)
                    .attr('x', (a) => xScale(a.day_of_week))
                    .attr('width', xScale.bandwidth())

                chart.selectAll('#limit').remove()
                chart.selectAll('.divergence').remove()
            })


            /*svg
            .append('text')
            .attr('class', 'label')
            .attr('x', -(height / 2) - margin)
            .attr('y', margin / 2.4)
            .attr('transform', 'rotate(-90)')
            .attr('text-anchor', 'middle')
            .text('Number of flights')

            svg.append('text')
            .attr('class', 'label')
            .attr('x', width / 2 + margin)
            .attr('y', height + margin * 1.7)
            .attr('text-anchor', 'middle')
            .text('Months')

            svg.append('text')
            .attr('class', 'title')
            .attr('x', width / 2 + margin)
            .attr('y', 40)
            .attr('text-anchor', 'middle')
            .text('Number of flights per month')

            svg.append('text')
            .attr('class', 'source')
            .attr('x', width - margin / 2)
            .attr('y', height + margin * 1.7)
            .attr('text-anchor', 'start')
            .text('Kaggle: 2015 Flight Delays and Cancellations')*/
            

                // Get names of cereals, for dropdown


        /*const weekdayFields = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday",
                            "Saturday", "Sunday"];
            d3.csv("Data/flight_weekday.csv").then(function(data) {
                const cerealMap = {};
                data.forEach(function(d) {
                    const cereal = d.cereal;
                    cerealMap[cereal] = [];

                    // { cerealName: [ bar1Val, bar2Val, ... ] }
                    weekdayFields.forEach(function(field) {
                        cerealMap[cereal].push( +d[field] );
                    });
                });
                makeVis(cerealMap);
            });

            const makeVis = function(cerealMap) {
                // Define dimensions of vis
                const margin = { top: 30, right: 50, bottom: 30, left: 50 },
                    width  = 550 - margin.left - margin.right,
                    height = 250 - margin.top  - margin.bottom;

                // Make x scale
                const xScale = d3.scaleBand()
                    .domain(weekdayFields)
                    .range([0, width], 0.1);

                // Make y scale, the domain will be defined on bar update
                const yScale = d3.scaleLinear()
                    .range([height, 0]);
                
                // Create canvas
                const canvas = d3.select("#airlineMonths")
                  .append("svg")
                    .attr("width",  width  + margin.left + margin.right)
                    .attr("height", height + margin.top  + margin.bottom)
                  .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                // Make x-axis and add to canvas
                const xAxis = () => d3.axisBottom()
                    .scale(xScale)
                    

                canvas.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                // Make y-axis and add to canvas
                const yAxis = () =>d3.axisLeft()
                    .scale(yScale)
                    

                var yAxisHandleForUpdate = canvas.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

                yAxisHandleForUpdate.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text("Value");
                
                var updateBars = function(data) {
                    // First update the y-axis domain to match data
                    yScale.domain( d3.extent(data) );
                    yAxisHandleForUpdate.call(yAxis);

                    var bars = canvas.selectAll(".bar").data(data);

                    // Add bars for new data
                    bars.enter()
                      .append("rect")
                        .attr("class", "bar")
                        .attr("x", function(d,i) { return xScale( weekdayFields[i] ); })
                        .attr("width", xScale.bandwidth())
                        .attr("y", function(d,i) { return yScale(d); })
                        .attr("height", function(d,i) { return height - yScale(d); });

                    // Update old ones, already have x / width from before
                    bars
                        .transition().duration(250)
                        .attr("y", function(d,i) { return yScale(d); })
                        .attr("height", function(d,i) { return height - yScale(d); });

                    // Remove old ones
                    bars.exit().remove();
                };

                // Handler for dropdown value change
                var dropdownChange = function() {
                    var newCereal = d3.select(this).property('value'),
                        newData   = cerealMap[newCereal];

                    updateBars(newData);
                };

                // Get names of cereals, for dropdown
                var cereals = Object.keys(cerealMap).sort();

                var dropdown = d3.select("#airlineMonths")
                    .insert("select", "svg")
                    .on("change", dropdownChange);

                dropdown.selectAll("option")
                    .data(cereals)
                  .enter().append("option")
                    .attr("value", function (d) { return d; })
                    .text(function (d) {
                        return d[0].toUpperCase() + d.slice(1,d.length); // capitalize 1st letter
                    });

                var initialData = cerealMap[ cereals[0] ];
                updateBars(initialData);
            }; */

    async function makeMonthsPlot() {
        dates = [
            {month:"Jan",count:469968},
            {month:"Feb",count:429191},
            {month:"Mar",count:504312},
            {month:"Apr",count:485151},
            {month:"May",count:496993},
            {month:"Jun",count:503897},
            {month:"Jul",count:520718},
            {month:"Aug",count:510536},
            {month:"Sep",count:464946},
            {month:"Oct",count:486165},
            {month:"Nov",count:467972},
            {month:"Dec",count:479230}
        ];
        const svg = d3.select('#monthsPlot');
        
        const margin = 80;
        const width = 700 - 2 * margin;
        const height = 500 - 2 * margin;

        const chart = svg.append('g')
            .attr('transform', `translate(${margin}, ${margin})`);

        const xScale = d3.scaleBand()
            .range([0, width])
            .domain(dates.map((s) => s.month))
            .padding(0.3)
        
        const yScale = d3.scaleLinear()
            .range([height, 0])
            .domain([0, 600000]);

        const makeYLines = () => d3.axisLeft()
            .scale(yScale)

        chart.append('g')
            .attr('transform', `translate(0, ${height})`)
            .call(d3.axisBottom(xScale));

        chart.append('g')
            .call(d3.axisLeft(yScale));
        
        chart.append('g')
            .attr('class', 'grid')
            .call(makeYLines()
                .tickSize(-width, 0, 0)
                .tickFormat('')
            ) 
        
        const barGroups = chart.selectAll()
            .data(dates)
            .enter()
            .append('g')
        
        barGroups
            .append('rect')
            .attr('class', 'barr')
            .attr('x', (g) => xScale(g.month))
            .attr('y', (g) => yScale(g.count))
            .attr('height', (g) => height - yScale(g.count))
            .attr('width', xScale.bandwidth())
            .on('mouseenter', function (actual, i) {
                d3.selectAll('.count')
                    .attr('opacity', 0)

                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 0.6)
                    .attr('x', (a) => xScale(a.month) - 5)
                    .attr('width', xScale.bandwidth() + 10)

                const y = yScale(actual.count)


                // barGroups.append('text')
                //     .attr('class', 'divergence')
                //     .attr('x', (a) => xScale(a.month) + xScale.bandwidth() / 2)
                //     .attr('y', (a) => yScale(a.count) + 30)
                //     .attr('fill', 'white')
                //     .attr('text-anchor', 'middle')
                //     .text((a, idx) => {
                //         const divergence = (a.count - actual.count).toFixed(1)

                //         let text = ''
                //         if (divergence > 0) text += ''
                //         text += `${divergence}`

                //         return idx !== i ? text : '';
                //     })
            })
            .on('mouseleave', function () {
                d3.selectAll('.value')
                    .attr('opacity', 1)

                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 1)
                    .attr('x', (a) => xScale(a.month))
                    .attr('width', xScale.bandwidth())

                chart.selectAll('#limit').remove()
                chart.selectAll('.divergence').remove()
            })

        barGroups 
            .append('text')
            .attr('class', 'value')
            .attr('x', (a) => xScale(a.month) + xScale.bandwidth() / 2)
            .attr('y', (a) => yScale(a.count) + 30)
            .attr('text-anchor', 'middle')
            .text((a) => `${a.count}`)
    
        svg
            .append('text')
            .attr('class', 'label')
            .attr('x', -(height / 2) - margin)
            .attr('y', margin / 2.4)
            .attr('transform', 'rotate(-90)')
            .attr('text-anchor', 'middle')
            .text('Number of flights')

        svg.append('text')
            .attr('class', 'label')
            .attr('x', width / 2 + margin)
            .attr('y', height + margin * 1.7)
            .attr('text-anchor', 'middle')
            .text('Months')

        svg.append('text')
            .attr('class', 'title')
            .attr('x', width / 2 + margin)
            .attr('y', 40)
            .attr('text-anchor', 'middle')
            .text('Number of flights per month')

        svg.append('text')
            .attr('class', 'source')
            .attr('x', width - margin / 2)
            .attr('y', height + margin * 1.7)
            .attr('text-anchor', 'start')
            .text('Kaggle: 2015 Flight Delays and Cancellations')
    }

    

    async function makeDatesPlot() {
        const data = (await d3.json('Data/dates.json'))
            .map((it) => ({date: new Date(Date.parse(it.date)), value: it.count}));
        const svg = d3.select('#datesPlot');
        new DatesLineChart(data, svg)
            .tooltipLines([d => dateWithWeekday(d.date), d => `${d.value} flights`])
            .draw();
    }
    function showAirportsList(airports, sortFunc) {
        const lst = d3.select('#airports');
        const selectedCode = lst.select('a.active').attr('data-value');
        const airportsArr = Object.values(airports);
        if (sortFunc !== undefined) {
            airportsArr.sort(sortFunc);
        }
        lst
            .select('.airports-items')
            .selectAll('a')
            .remove();
        lst
            .select('.airports-items')
            .selectAll('a')
            .data(airportsArr)
            .enter()
            .append('a').attr('href', 'javascript:void(0)').attr('class', 'list-group-item list-group-item-action')
            .attr('data-value', airport => airport.iata_code)
            .html(airport => `${airport.iata_code}
                    <div>${airport.airport}, ${airport.city}, ${airport.state}</div>
                    <span data-toggle="tooltip" title="Number of incoming/outgoing airports and flights">
                    in <b>${airport.incomingAirports.length} (${airport.incomingFlightsCount})</b>,
                    out <b>${airport.outgoingAirports.length} (${airport.outgoingFlightsCount})</b></span>`);
        lst.select(`a[data-value="${selectedCode}"]`).classed('active', true);
    }
    function drawRoutes(markersLayer, routes, airports) {
        markersLayer.clearLayers();
        const weightScaler = d3.scaleLinear()
            .domain([0, d3.max(routes, r => r.count)])
            .range([0, 2]);
        routes.forEach(route => {
            const originAirport = airports[route.origin_airport];
            const destinationAirport = airports[route.destination_airport];
            const pointList = [
                [Number(originAirport.latitude), Number(originAirport.longitude)],
                [Number(destinationAirport.latitude), Number(destinationAirport.longitude)]
            ];
            markersLayer.addLayer(L.polyline(pointList, {color: 'red', weight: weightScaler(route.count)}));
        });

        svg.append('text')
            .attr('class', 'source')
            .attr('x', width - margin / 2)
            .attr('y', height + margin * 1.7)
            .attr('text-anchor', 'start')
            .text('Kaggle: 2015 Flight Delays and Cancellations')
    }

    async function makeAirportsDestinationsPlots() {
        const sample = [
            {
                count: 41995,
                destination_airport: "ATL"
            },
            {
                count: 33392,
                destination_airport: "ORD"
            },
            {
                count: 32765,
                destination_airport: "DFW"
            },
            {
                count: 24462,
                destination_airport: "LAX"
            },
            {
                count: 24022,
                destination_airport: "DEN"
            },
            {
                count: 18985,
                destination_airport: "IAH"
            },
            {
                count: 18536,
                destination_airport: "PHX"
            },
            {
                count: 18159,
                destination_airport: "SFO"
            },
            {
                count: 16419,
                destination_airport: "LAS"
            },
            {
                count: 14167,
                destination_airport: "MCO"
            }
        ];
        const svg = d3.select('#airportsDestinationsPlot');
        
        const margin = 80;
        const width = 700 - 2 * margin;
        const height = 500 - 2 * margin;

        const chart = svg.append('g')
            .attr('transform', `translate(${margin}, ${margin})`);

        const xScale = d3.scaleBand()
            .range([0, width])
            .domain(sample.map((s) => s.destination_airport))
            .padding(0.3)
        
        const yScale = d3.scaleLinear()
            .range([height, 0])
            .domain([0, 50000]);

        const makeYLines = () => d3.axisLeft()
            .scale(yScale)

        chart.append('g')
            .attr('transform', `translate(0, ${height})`)
            .call(d3.axisBottom(xScale));

        chart.append('g')
            .call(d3.axisLeft(yScale));
        
        chart.append('g')
            .attr('class', 'grid')
            .call(makeYLines()
                .tickSize(-width, 0, 0)
                .tickFormat('')
            ) 
        
        const barGroups = chart.selectAll()
            .data(sample)
            .enter()
            .append('g')
        
        barGroups
            .append('rect')
            .attr('class', 'bar')
            .attr('x', (g) => xScale(g.destination_airport))
            .attr('y', (g) => yScale(g.count))
            .attr('height', (g) => height - yScale(g.count))
            .attr('width', xScale.bandwidth())
            .on('mouseenter', function (actual, i) {
                d3.selectAll('.count')
                    .attr('opacity', 0)

                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 0.6)
                    .attr('x', (a) => xScale(a.destination_airport) - 5)
                    .attr('width', xScale.bandwidth() + 10)

                const y = yScale(actual.count)

                line = chart.append('line')
                    .attr('id', 'limit')
                    .attr('x1', 0)
                    .attr('y1', y)
                    .attr('x2', width)
                    .attr('y2', y)

                // barGroups.append('text')
                //     .attr('class', 'divergence')
                //     .attr('x', (a) => xScale(a.destination_airport) + xScale.bandwidth() / 2)
                //     .attr('y', (a) => yScale(a.count) + 30)
                //     .attr('fill', 'white')
                //     .attr('text-anchor', 'middle')
                //     .text((a, idx) => {
                //         const divergence = (a.count - actual.count).toFixed(1)

                //         let text = ''
                //         if (divergence > 0) text += ''
                //         text += `${divergence}`

                //         return idx !== i ? text : '';
                //     })
            })
            .on('mouseleave', function () {
                d3.selectAll('.count')
                    .attr('opacity', 1)

                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 1)
                    .attr('x', (a) => xScale(a.destination_airport))
                    .attr('width', xScale.bandwidth())

                chart.selectAll('#limit').remove()
                chart.selectAll('.divergence').remove()
            })

        barGroups 
            .append('text')
            .attr('class', 'value')
            .attr('x', (a) => xScale(a.destination_airport) + xScale.bandwidth() / 2)
            .attr('y', (a) => yScale(a.count) + 30)
            .attr('text-anchor', 'middle')
            .text((a) => `${a.count}`)
    
        svg
            .append('text')
            .attr('class', 'label')
            .attr('x', -(height / 2) - margin)
            .attr('y', margin / 2.4)
            .attr('transform', 'rotate(-90)')
            .attr('text-anchor', 'middle')
            .text('Number of flight destinations')

        svg.append('text')
            .attr('class', 'label')
            .attr('x', width / 2 + margin)
            .attr('y', height + margin * 1.7)
            .attr('text-anchor', 'middle')
            .text('Airports')

        svg.append('text')
            .attr('class', 'title')
            .attr('x', width / 2 + margin)
            .attr('y', 40)
            .attr('text-anchor', 'middle')
            .text('Airports with flight destinations')

        svg.append('text')
            .attr('class', 'source')
            .attr('x', width - margin / 2)
            .attr('y', height + margin * 1.7)
            .attr('text-anchor', 'start')
            .text('Kaggle: 2015 Flight Delays and Cancellations')

                

    }
    
    async function makeAirlinesDelaysPlot() {
        const data = (await d3.json('Data/airlines_delays.json'))
            .map(it => ({name: it.airline, value: it.delay_rate * 100, size: it.flights_count}))
        const svg = d3.select('#airlinesDelaysPlot')
        const width = Number(svg.attr('width'));
        const height = Number(svg.attr('height'));
        const margin = ({top: 20, right: 0, bottom: 30, left: 40});
        const x = d3.scaleBand()
            .domain(data.map(d => d.name))
            .range([margin.left, width - margin.right])
            .padding(0.1)
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.value)]).nice()
            .range([height - margin.bottom, margin.top]);
        const sizeScaler = d3.scaleLinear()
            .domain([d3.min(data, it => it.size), d3.max(data, it => it.size)])
            .range([8, 20]);
        const itemColor = d3.scaleOrdinal(["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf",
            "#d95f02", "#e7298a", "#7570b3", "#1b9e77"]);
        const xAxis = g => g
            .attr('transform', `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x).tickSize(-height, 0, 0));
        const yAxis = g => g
            .attr('transform', `translate(${margin.left},0)`)
            .call(d3.axisLeft(y).tickFormat(d => d.toFixed(1) + '%').tickSize(-width, 0, 0))
            .call(g => g.select(".domain").remove());

            
        svg.append('g')
            .selectAll('circle')
            .data(data).enter().append('circle')
            .style('fill', d => itemColor(d.name))
            .attr('cx', d => x(d.name) + x.bandwidth() / 2)
            .attr('cy', d => y(d.value))
            .attr('r', d => sizeScaler(d.size))
            .on('mouseenter', function (actual, i) {
                d3.selectAll('.value')
                    .attr('opacity', 0)
                    .on("mouseover", mouseOver)
                    .on("mouseout", mouseOut)
        

                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 0.6)
                    .attr('x', (a) => xScale(a.name) - 5)
                    .attr('width', xScale.bandwidth() + 10)

                const y = yScale(actual.value)
            })
            .on('mouseleave', function () {
                d3.selectAll('.value')
                    .attr('opacity', 1)

                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 1)
                    .attr('x', (a) => xScale(a.name))
                    .attr('width', xScale.bandwidth())

                chart.selectAll('#limit').remove()
                chart.selectAll('.divergence').remove()
            })
        svg.append('g').call(xAxis);
        svg.append('g').call(yAxis);

    
    }

</script>



  
  <div id="footer">
    <p>Aziz Emil Walid&copy;2019</p>
  </div>
  
  <script>
    makeMonthsPlot();
    makeDatesPlot();
    makeAirlinesDelaysPlot();
    makeAirportsDestinationsPlots();

  </script>
</body>

</html>