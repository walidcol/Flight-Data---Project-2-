<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Flight Project</title>
  <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
    crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
  <script type="text/javascript" src="charts.js"></script>
  <script type="text/javascript" src="utils.js"></script>
   

</head>


<body>
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <h1>FLIGHT PROJECT</h1>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12  col-md-9">
        <div id="scatter">

        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12  col-md-9">
        
      </div>
    </div>
  </div>

  <p>
        <a href="https://www.kaggle.com/usdot/flight-delays">Kaggle 2015 Flight Delays and Cancellations</a> dataset
        (with <a href="https://www.kaggle.com/smiller933/fixing-airport-codes">this fix</a> for some airport codes).
    It has information about flights for major US airlines in 2015 (arrival/departure times, delay, flight ID, distance, ...)
    and information about airport cities/coordinates, airlines.
    </p>
    <p>
        The data was retrieved via SQL queries in PostgresSQL database, using <code class="code">ROW_TO_JSON</code> for export.
    </p>

    <h1>The most/least busiest months of the year</h1>

    <h3 class="plot-title">Flights per month</h3>
    <svg id="monthsPlot" class="plot" width="600" height="300"></svg>

    <div class="code-spoiler">
        <a data-toggle="collapse" role="button">SQL</a>
        <div class="collapse">
            <div class="card card-body code-panel">
                <pre class="code"><code>SELECT month, count(*)
FROM flights
GROUP BY month</code></pre>
            </div>
        </div>
    </div>

    <h3 class="plot-title">Flights by date</h3>
    <div>Hover to see data at the selected point.</div>
    <svg id="datesPlot" class="plot" width="800" height="300"></svg>

    <div class="code-spoiler">
        <a data-toggle="collapse" role="button">SQL</a>
        <div class="collapse">
            <div class="card card-body code-panel">
                <pre class="code"><code>SELECT make_date(year, month, day) as date, count(*)
FROM flights
GROUP BY date</code></pre>
            </div>
        </div>
    </div>

    <p>
        As we can see, the most busiest months are in the summer (especially July-August), probably because of holidays,
        also there are some increases in the beginning of Spring (Easter, Spring break?),
        and the least active period is from middle of January to middle of February.
    </p>
    <p>
        Also it depends on day of the week: there is a huge drop of activity on Saturdays, probably related to business trips.
    </p>


    <h1>Airports with mot flight destinations</h1>

    <svg id="airlinesDelaysPlot" class="plot" width="800" height="300"></svg>


    <h1>Airlines with the most/least delays</h1>
    <p>Circle size represents airline size (number of flights) and Y axis shows its' delay rate (counting only delays that were longer than 10 minutes).</p>
    <svg id="airlinesDelaysPlot" class="plot" width="800" height="300"></svg>

    <div class="code-spoiler">
        <a data-toggle="collapse" role="button">SQL</a>
        <div class="collapse">
            <div class="card card-body code-panel">
                <pre class="code"><code>SELECT airline,
       ROUND(count(*) / (SELECT count(*) FROM flights WHERE f.airline=f.airline)::decimal, 4) as delay_rate,
       (SELECT count(*) FROM flights WHERE airline=f.airline) as flights_count
FROM flights as f
WHERE departure_delay > 10
GROUP BY airline</code></pre>
            </div>
        </div>
    </div>

    <p>The chart shows that most of the delays occur on flights from big airlines, smaller airlines seem to have less delays.</p>

    <footer>
        <hr/>
        <a href="https://github.com/walidcol/Flight-Data---Project-2-">Source code</a>
    </footer>
</div>

<script>
    async function makeMonthsPlot() {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const data = (await d3.json('../Data/months.json'))
            .map((it) => ({name: monthNames[it.month - 1], value: it.count}));
        const svg = d3.select('#monthsPlot');
        new BarChart(data, svg).draw();
    }

    async function makeDatesPlot() {
        const data = (await d3.json('../Data/dates.json'))
            .map((it) => ({date: new Date(Date.parse(it.date)), value: it.count}));
        const svg = d3.select('#datesPlot');
        new DatesLineChart(data, svg)
            .tooltipLines([d => dateWithWeekday(d.date), d => `${d.value} flights`])
            .draw();
    }
    function showAirportsList(airports, sortFunc) {
        const lst = d3.select('#airports');
        const selectedCode = lst.select('a.active').attr('data-value');
        const airportsArr = Object.values(airports);
        if (sortFunc !== undefined) {
            airportsArr.sort(sortFunc);
        }
        lst
            .select('.airports-items')
            .selectAll('a')
            .remove();
        lst
            .select('.airports-items')
            .selectAll('a')
            .data(airportsArr)
            .enter()
            .append('a').attr('href', 'javascript:void(0)').attr('class', 'list-group-item list-group-item-action')
            .attr('data-value', airport => airport.iata_code)
            .html(airport => `${airport.iata_code}
                    <div>${airport.airport}, ${airport.city}, ${airport.state}</div>
                    <span data-toggle="tooltip" title="Number of incoming/outgoing airports and flights">
                    in <b>${airport.incomingAirports.length} (${airport.incomingFlightsCount})</b>,
                    out <b>${airport.outgoingAirports.length} (${airport.outgoingFlightsCount})</b></span>`);
        lst.select(`a[data-value="${selectedCode}"]`).classed('active', true);
    }
    function drawRoutes(markersLayer, routes, airports) {
        markersLayer.clearLayers();
        const weightScaler = d3.scaleLinear()
            .domain([0, d3.max(routes, r => r.count)])
            .range([0, 2]);
        routes.forEach(route => {
            const originAirport = airports[route.origin_airport];
            const destinationAirport = airports[route.destination_airport];
            const pointList = [
                [Number(originAirport.latitude), Number(originAirport.longitude)],
                [Number(destinationAirport.latitude), Number(destinationAirport.longitude)]
            ];
            markersLayer.addLayer(L.polyline(pointList, {color: 'red', weight: weightScaler(route.count)}));
        });
    }
    
    async function makeAirlinesDelaysPlot() {
        const data = (await d3.json('../Data/airlines_delays.json'))
            .map(it => ({name: it.airline, value: it.delay_rate * 100, size: it.flights_count}));
        const svg = d3.select('#airlinesDelaysPlot');
        const width = Number(svg.attr('width'));
        const height = Number(svg.attr('height'));
        const margin = ({top: 20, right: 0, bottom: 30, left: 40});
        const x = d3.scaleBand()
            .domain(data.map(d => d.name))
            .range([margin.left, width - margin.right])
            .padding(0.1);
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.value)]).nice()
            .range([height - margin.bottom, margin.top]);
        const sizeScaler = d3.scaleLinear()
            .domain([d3.min(data, it => it.size), d3.max(data, it => it.size)])
            .range([8, 20]);
        const itemColor = d3.scaleOrdinal(["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf",
            "#d95f02", "#e7298a", "#7570b3", "#1b9e77"]);
        const xAxis = g => g
            .attr('transform', `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x).tickSize(-height, 0, 0));
        const yAxis = g => g
            .attr('transform', `translate(${margin.left},0)`)
            .call(d3.axisLeft(y).tickFormat(d => d.toFixed(1) + '%').tickSize(-width, 0, 0))
            .call(g => g.select(".domain").remove());
        svg.append('g')
            .selectAll('circle')
            .data(data).enter().append('circle')
            .style('fill', d => itemColor(d.name))
            .attr('cx', d => x(d.name) + x.bandwidth() / 2)
            .attr('cy', d => y(d.value))
            .attr('r', d => sizeScaler(d.size));
        svg.append('g').call(xAxis);
        svg.append('g').call(yAxis);
    }


</script>



  
  <div id="footer">
    <p>Aziz Emil Walid&copy;2019</p>
  </div>
  
  <script>
    makeMonthsPlot();
    makeDatesPlot();
    makeAirlinesDelaysPlot();
  </script>
</body>

</html>